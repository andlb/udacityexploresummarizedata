---
Title: Prosper loan data exploration
author: "Andre Luis Borges"
date: "Feb 24, 2018"
output:
  pdf_document: default
  html_document: default
---

#Prosper loan data exploration by Andre Luis Borges

```{r echo=FALSE, message=FALSE, warning=FALSE, Load_the_Data}

# Installing libraries
#install.packages("ggplot2", dependencies = T) 
#install.packages("knitr", dependencies = T)
#install.packages("dplyr", dependencies = T)
#install.packages("rmarkdown")

# Loading libraries
library(ggplot2)
library(knitr)
library(tidyr)
library(dplyr)
library(GGally)
library(scales)
library(memisc)
library(gridExtra)
library(grid)

prosper_loan = ""

#load the dataset in prosper_loan variable.
load_data <- function() {
  # TODO: This code should be removed
  #setwd('C:\\projetos\\r\\finalproject')  
  prosper_loan <<- read.csv('prosperLoanData.csv',sep=',')
  
  #gettting the year from the data the loan was originated
  prosper_loan$year <<- substr(prosper_loan$LoanOriginationDate, 1,4)
  #create creditscore variable
  prosper_loan <<- prosper_loan %>% 
      mutate(CreditScore = ((CreditScoreRangeLower / 2) + (CreditScoreRangeUpper / 2)))
  prosper_loan <- prosper_loan %>%
    filter(IncomeRange!="Not displayed") %>%
    mutate(IncomeRange = replace(IncomeRange, IncomeRange=='$0', 'Not employed')) %>%
    as.data.frame()   
}

#get the prosper rating variable differente the empty.
notempty_posperRating <- function() {
  prosper_loan_temp <<- prosper_loan %>%
    filter(ProsperRating..Alpha. != '')
}

#get the prosper rating variable differente the empty.
notna_property <- function(varnotna) {
  #varnotna - variable name
  prosper_loan_temp <<- prosper_loan %>%
    filter(!is.na(varnotna))
}

#get the prosper score valid (#11) and not empty
notempty_valid_ProsperScore <- function() {
  prosper_loan_temp <<- prosper_loan %>%
    filter(ProsperScore != '', ProsperScore != 11)
}
#load the data.
load_data()
```

#Introduction

Prosper is a peer to peer lending company that offers personal loans at low rates. These loans are unsecured, which means you do not have to put up any collateral (like a house or car) that could get taken away if you can't make payments. Each loan is typically funded by multiple people all over the United States.[4]  
During this exploratory data analyze, **I will investigate about investment return, investment loss and the risk for investors.**

#Analysis

The data set contains 113,937 observations with 81 variables on each loan, including loan amount, borrower rate, current loan status, borrower income, borrower employment status, borrower credit history, number of investors, prosper rating and the latest payment information. More information about the prosper loan dictionary is available at the web address: https://docs.google.com/spreadsheets/d/1gDyi_L4UvIrLTEC6Wri5nbaMmkGmLQBk-Yx3z0XDEtI/edit?usp=sharing.  
The first part of the analysis is demonstrate the dataset structure.
```{r echo=FALSE}
str(prosper_loan)
```
  
##Univariate plots

This part of the investigation will analyze the data distribution.

###Investor
The investor is any person or organization who commits capital with the expectation of financial returns[1]. At Prosper Company, the loan can be fund by one or more investor.  
**I would like to know how much investor funds a loan?**  
```{r echo=FALSE, histogramnumberofinvestor ,message=FALSE, warning=FALSE}
#histogram number of investor
ggplot(prosper_loan,aes(Investors)) + 
        geom_histogram(binwidth = 30, fill = '#68896a') +
        ggtitle('Investors - Numbers of investor that funded a loan') +
        labs(x="Numbers of investor")
```

The number of investor in a loan vary from 1 to 1189. On average, the loan has around 80 investors, but frequently just one investor funds a loan. The last plot with a positive skew distribution and a long tail showed the distribution from the number of investor by loan.  

###Estimated loss and return.  

After July 2009, the variable estimated effective yield, estimated loss and estimated return was added to the dataset. Effective yield is equal to the borrower interest rate minus the servicing fee rate, minus estimated uncollected interest on charge-offs, plus estimated collected late fees. The estimated loss is the estimated principal loss on charge-offs.[8]   
**I would like to use these variables to find out how much is the estimated loss and estimated return for an investor?**  
A density plot with the estimated loss and effective yield in percentage will help us to answer this question.  

```{r echo=FALSE, message=FALSE, warning=FALSE}
#filter the estimated return different "na"" and gather two columns in a key-value pair.
prosper_loan_with_EstimatedReturn <- prosper_loan %>%
  filter(!is.na(prosper_loan$EstimatedReturn)) %>%
  gather(key, value, EstimatedLoss:EstimatedEffectiveYield)

#Densit plot from EstimatedLoss and EstimatedEffectiveYield variable
ggplot(data = prosper_loan_with_EstimatedReturn) + 
    geom_density(aes(value * 100, fill = key, color = key), alpha = 0.5) +
    scale_fill_manual(values = c('#a2b285', '#e1b582')) + 
    scale_color_manual(values = c('#a2b285', '#e1b582')) +
    scale_y_continuous(name = "Density")+
    scale_x_continuous(name = "Estimate loss and effective yield in percentage") +
    ggtitle('Density from the Estimated loss and effective yield in percentage') 

#filter EstimatedReturn != ""
notna_property(prosper_loan$EstimatedReturn)

#calculate avg from EstimatedLoss and EstimatedEffectiveYield
avg_of_loss <- round(mean(prosper_loan_temp$EstimatedLoss * 100), 2)
avg_of_yield <- round(mean(prosper_loan_temp$EstimatedEffectiveYield * 100), 2)

```

I figured out both estimated loss and effective yield in percentage in the same plot will clarify that both variables show multimodal distribution. The effective yield covers a larger positive area from the plot than the estimate loss, what means it is more likely it get an effective yield greater than estimated loss. On average, the estimated loss is `r avg_of_loss`% and the effective yield is `r avg_of_yield`.   
Estimated return variable is the difference between the Estimated Effective Yield and the Estimated Loss Rate.[8] 
A plot from this variable will go to the heart of the last question.  

```{r echo=FALSE}
#Histogram from estimated return
ggplot(prosper_loan_with_EstimatedReturn, aes(EstimatedReturn * 100)) + 
      geom_histogram(binwidth = 1, fill='#a2b285') +
      ggtitle('Estimated return ') +
      labs(x = "Estimated return in percentage")

#calculate avg, max, min and quartile from EstimatedReturn
avg_of_return <- round(mean(prosper_loan_with_EstimatedReturn$EstimatedReturn * 100),2)
min_of_return <- round(min(prosper_loan_with_EstimatedReturn$EstimatedReturn * 100),2)
max_of_return <- round(max(prosper_loan_with_EstimatedReturn$EstimatedReturn * 100),2)
quart_25_of_return <- quantile(prosper_loan_with_EstimatedReturn$EstimatedReturn * 100, 0.25)
quart_75_of_return <- quantile(prosper_loan_with_EstimatedReturn$EstimatedReturn * 100, 0.75)

rm(prosper_loan_with_EstimatedReturn)
```

The histogram from the estimated return shows good news. Loan founders can have great returns.
Analyzing the estimated return distribution, it is a normal distribution with frequently returns in the positive area from the plot what means it is likely the investor will have a positive return from their investment. The average return is around `r avg_of_return`%.  
The minimum is `r min_of_return` and it is not superior to `r max_of_return` percent by year and 50% of the loan has estimated return varying from `r quart_25_of_return`% to `r quart_75_of_return`%.  

###Credit management.  
Credit management is the process of granting credit, the terms it's granted on and recovering this credit when it's due. This is the function within a bank or company to control credit policies that will improve revenues and reduce financial risks.[10]  
One of the key question for an investor is to figure out the investment risk level and the dataset has rating variable that should answer the question: **How much is the investiment risk when the investor fund a loan?.**  
The prosper score and the prosper rating were built after 2009 to custom risk using historical proper data. For prosper score, the score ranges from 1-10, with 10 being the best, or lowest risk score. Prosper rating is categorized in this way: 1 - HR, 2 - E, 3 - D, 4 - C, 5 - B, 6 - A, 7 - AA, where HR is the riskier and AA is the safer category.[8]  

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

#filter ProsperScore != '' and ProsperScore != 11 - (probably mistype error)
notempty_valid_ProsperScore()
prosper_loan_temp$ProsperScore <- as.factor(prosper_loan_temp$ProsperScore)

#histogram from ProsperScore
p1 <- ggplot(prosper_loan_temp, aes(ProsperScore)) + 
        geom_histogram(stat = "count", fill = '#e1b582') +
        ggtitle('Prosper score') +
        labs(x = "From 1 (higher risk) to 10 (lower risk)") 
rm(prosper_loan_temp)
#create the dataset prosper_loan_temp.
notempty_posperRating()
#histogram from ProsperRating..Alpha.
p2 <- ggplot(prosper_loan_temp, aes(ProsperRating..Alpha.)) + 
  geom_histogram(stat = "count", fill = '#a2b285') +
  scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E','HR')) +
  ggtitle('Prosper rating') +
  labs(x = "AA (lower risk) to HR (higher risk).") 

rm(prosper_loan_temp)
#two plot in the same chart(p1 and p2).
grid.arrange(p1,p2,ncol=2)
```

An interesting point about these plots, prosper score plot has lower risk greater than higher risk and prosper rating is inverse. **What is the most trustworthy variable?**.  
The dataset also store the lower and upper credit score provided by a consumer credit rating agency.
The next plot will show the distribution from the lower divided by the upper range. Closer the one, closer is the difference between them.  

```{r echo=FALSE, message=FALSE, warning=FALSE}
#filter not na CreditScoreRangeUpper
notna_property(prosper_loan$CreditScoreRangeUpper)

#The proportion from CreditScoreRangeLower by CreditScoreRangeUpper
prosper_loan_temp$CreditScoreProp <- prosper_loan_temp$CreditScoreRangeLower / prosper_loan_temp$CreditScoreRangeUpper

# histogram from the proportion
ggplot(prosper_loan_temp, aes(CreditScoreProp )) + 
      geom_histogram(binwidth = 0.01) +
      ggtitle('Credit Score rating') +
      labs(x = "Proportion between the upper and lower score rating range.")
```

The result is a skinny distribution close to 1, what means the upper and the lower value is very close, what also mean the average won't have significant bias.  
I've included the average between the upper and lower credit score with the name credit score in the dataset.  

```{r echo=FALSE, message=FALSE, warning=FALSE}
#histogram from credit score.
ggplot(prosper_loan_temp, aes(CreditScore)) + 
        geom_histogram( binwidth = 20, fill = '#68896a') +
        ggtitle('Credit score provided by a consumer credit rating agency.') +
        labs(x="Credit score")
```

Lower credit score means higher risk and higher credit score means safer loans. The prosper rating, prosper score and credit score plot show a normal distribution where the amount of loans for higher and lower risk are lower than for the intermediary score.  
**This variable allow me to analyze the company actions after a great crise, like 2008 financial crisi.**   

```{r echo=FALSE}
#histograms from the CreditScore for year < 2008 and >= 2008 
p1 <- ggplot(subset(prosper_loan_temp,prosper_loan_temp$year <= 2008), aes(CreditScore)) + 
        geom_histogram(binwidth = 20, fill = '#68896a') +
        ggtitle('Credit score provided by a consumer credit rating agency.') +
        labs(x = "Credit score")

p2 <- ggplot(subset(prosper_loan_temp,prosper_loan_temp$year > 2008), aes(CreditScore)) +
        geom_histogram(binwidth = 20, fill = '#68896a') +
        ggtitle('Credit score provided by a consumer credit rating agency.') +
        labs(x = "Credit score")
#two histogram side by side.
grid.arrange(p1,p2,ncol=2)
```

The main change is the left side of the distribution. Before 2008, borrowers got loan with credit score lower than 500 and after 2008, clearly the minimum score was around 600.  

Summary with loans until 2008.  
```{r echo=FALSE, message=FALSE, warning=FALSE}
summary(subset(prosper_loan_temp,prosper_loan_temp$year <= 2008)$CreditScore)
```

Summary with loans after 2008.  
```{r echo=FALSE, message=FALSE, warning=FALSE}
summary(subset(prosper_loan_temp,prosper_loan_temp$year > 2008)$CreditScore)
rm(prosper_loan_temp)
```
There are a huge difference between the minimum score before and after 2008.  
**What is the most reliable score?**  
Lower is the number of default loans in the safer loan level and higher is around the higher risk level, the more reliable is that score.  

```{r echo=FALSE}
#filter the loan status defaulted and ProsperScore != '', ProsperScore != 11
prosper_loan_temp <- prosper_loan %>%
  filter(ProsperScore != '', ProsperScore != 11, LoanStatus == 'Defaulted')
prosper_loan_temp$ProsperScore <- as.factor(prosper_loan_temp$ProsperScore)
#it will create 3 plots side by side.
#first histogram by ProsperScore
p1 <- ggplot(prosper_loan_temp, aes(ProsperScore)) + 
        geom_histogram(stat="count", fill = '#e1b582') +
        ggtitle('Prosper score') +
        ylim(0,300)+
        labs(x="From 1 (higher risk) to 10 (lower risk)") 

rm(prosper_loan_temp)

#filter the status defaulted and ProsperRating..Alpha. != ''
prosper_loan_temp <- prosper_loan %>%
  filter(ProsperRating..Alpha. != '',LoanStatus == 'Defaulted')
#second histogram by prosper ProsperRating..Alpha
p2 <- ggplot(prosper_loan_temp, aes(ProsperRating..Alpha.)) + 
  geom_histogram(stat="count", fill = '#a2b285') +
  scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E','HR')) +
  ggtitle('Prosper rating') +
  ylim(0,300)+
  labs(x = "AA (lower risk) to HR (higher risk).") 

rm(prosper_loan_temp)

#filter by loans defaulted and year > 2008
prosper_loan_temp <- prosper_loan %>%
  filter(year > 2008, LoanStatus == 'Defaulted')

#Third histogram by CreditScore, year > 2008
p3 <- ggplot(prosper_loan_temp, aes(CreditScore)) + 
        geom_histogram( binwidth = 20, fill = '#68896a') +
        ggtitle('Credit score provided by a consumer credit rating agency.') +
  ylim(0,300)+
        labs(x="Credit score")

grid.arrange(p1,p2,p3,ncol=3)
rm(prosper_loan_temp)
```

With exception of the prosper rating, the distribution is close to normal. However, for this distribution, the expected is the number of loans increases with the risk level. Just the prosper rating was close to the expected.  
###Loan  

A loan is the lending of money from one individual, organization or entity to another individual, organization or entity at an interest rate.[9]  
I think, Prosper business will be good for investor if the numbers of loans increase and the number of default loans be close to zero.  

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Histogram by number of loans by year
ggplot(prosper_loan, aes(year)) + 
        geom_histogram(stat = "count", fill = '#ae926a') +
        ggtitle('Number of loans by year') +
        labs(x = "Years")
```

From 2009 to 2013, the amount of loans has strongly increases. 2014, the data was collected until March, consequently there was a sharp fall.  
It shows the confidence from the investors and borrowers have in the business.  

```{r echo=FALSE, message=FALSE, warning=FALSE}
# #filter prosper loan status defaulted
prosper_loan_temp <- prosper_loan %>%
  filter( LoanStatus == 'Defaulted')
#histogram by the number of defaulted by year 
ggplot(data = prosper_loan_temp, aes(year)) + 
        geom_histogram(stat = "count", fill = '#ae926a') +
        ggtitle('Number of defaulted loans by year') +
        labs(x = "Years")
rm(prosper_loan_temp)
```

Until 2008, the number of default loans was higher, and after that, the credit management has improved.

###Income

Income is the money that the borrower receives in exchange for providing a good or service[3]. 
The Prosper dataset stores the income range of the borrower at the time the listing was created. The income verifiable variable indicates the borrower have the required documentation to support their income.  

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Update the incomerange variable for 0$ to not employed
prosper_loan_temp <- prosper_loan %>%
  filter(IncomeRange!="Not displayed") %>%
  mutate(IncomeRange = replace(IncomeRange, IncomeRange=='$0', 'Not employed')) %>%
  as.data.frame()  

#histogram from the income range 
ggplot(data = prosper_loan_temp, aes(x = IncomeRange)) +
        geom_histogram(stat = "count", fill = '#7d874c') +
        scale_x_discrete(limits = c('Not employed','$1-24,999', '$25,000-49,999', '$50,000-74,999', '$75,000-99,999', '$100,000+' ))+
        ggtitle('Range income distribution') +
        labs(x = "Income range")
#count the number of income verifiable
total_income_verified <- prosper_loan %>%
  filter(IncomeVerifiable == 'True') %>%
  summarise(total = n())
#calculate the total loans by the number ofincome verifiable
percent_total_income_verified = round((total_income_verified$total / count(prosper_loan)) * 100, 2)

rm(prosper_loan_temp)
```

The income from the most part of the borrower vary from 25,000 to 74,999, according the range income distribution plot. The dataset also shows, `r percent_total_income_verified$n`% has document to support their income.  

# Univariate Analysis  

There were some question about the investment risk when I started the investigation. The key questions were **How much investment return can a investor get? How much can they lose? What are the risks? Are there any classification to mesure the risk?**  
During this initial investigation, I figured out variables that could answer these questions.   
A brief analyze about the first part of the investigation.  

### What is the structure of your dataset?  
The data set contains 113,937 observations with 81 variables on each loan, including loan amount, borrower rate, current loan status, borrower income, borrower employment status, borrower credit history, number of investors, prosper rating and the latest payment information. 
There are 9 categorical variable, 3 variables is key to other database table, and 63 are integer or numeric variable.  

### What is/are the main feature(s) of interest in your dataset?  
I'm looking for a feature to measure the investidor risk. This first investigation, I figured out the default loan happens with higher frequency in the high-risk  than the safer prosper rate level definition. It means, the prosper rating is the main feature because it can measure the investiment risk.   

### What other features in the dataset do you think will help your investigation into your features of interest?
The features will help the investigation are: Loan status, estimated return, estimated loss, prosper score, credit score, the borrower income range, and their employment status.  

### Did you create any new variables from existing variables in the dataset?  
Yes, I create two new features: year and credit score. Year is the year the loan was originated and the creditscore is the average of upper and lower range from the borrower credit score provided by a customer credit rating agency.  

### Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?  
No, there weren't any usual distribution. I performed operation to adjust the data. For income range, I considered as not employed the borrower with 0 range income. The reason, for my analyze, there was not differece from the 0 income and not employed income range.  

# Bivariate Plots Section  

During the first part of the investigation, we figured out the amount of default loan is higher for high-risk investment definition.    
We will go deep to understand the relationship between the ratings and the estimated return, estimated loss, default and delinquency loans.    
First, the ggapairs gets a quickly overview from the impact on the estimated loss and estimated yield return variable caused by the different ratings variable.    

```{r echo=FALSE, warning = FALSE, message=FALSE}
#filter the prosperscore # na
notna_property(prosper_loan$ProsperScore)
prosper_loan_temp$ProsperScore <- as.numeric(prosper_loan_temp$ProsperScore)

#Select the varible to show at the ggpairs plot.
tprosper_loan <- subset(prosper_loan_temp, select = c(
  EstimatedLoss,
  EstimatedEffectiveYield,
  ProsperRating..numeric.,
  ProsperRating..Alpha.,
  ProsperScore,
  CreditScore
))
#select a sample with 600 value
tprosper_loan <- tprosper_loan[sample(1:600,600),] 
#show the ggpairs plot
ggpairs(tprosper_loan,
        title="Data analysis")
rm(tprosper_loan)

```

**I would like to know what happens with the estimated loss when the risk vary from low to higher.**   
The prosper rating and estimated loss variable will be plotted together in a scatter plot.  

```{r echo=FALSE}
#filter no empty ProsperRating..Alpha.
notempty_posperRating()

#scatter plot estimated loss by ProsperRating..Alpha.
ggplot(aes(y = EstimatedLoss, x = ProsperRating..Alpha.), data = prosper_loan_temp) + 
  geom_point(alpha= 0.01,color='#ae926a',position='jitter') + 
  scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E','HR')) +
  ggtitle('Estimated Loss by prosper rating.')+        
  labs(x = 'AA (lower risk) to HR (higher risk, higher return).', y = 'Estimated Loss.') 

rm(prosper_loan_temp)
``` 

Evidently, there is a strong relationship between them. Lower is the risk, lower is the estimated return and higher is the risk, higher is the estimated loss.  
Instead of prosper rating, a similar plot will be created with the credit score and prosper score variable.  

```{r echo=FALSE, warning = FALSE}
#filter ProsperScore != '', ProsperScore != 11
notempty_valid_ProsperScore()
prosper_loan_temp$ProsperScore <- as.factor(prosper_loan_temp$ProsperScore)
# scatter plot from EstimatedLoss (percent) by ProsperScore
p1 <- ggplot(prosper_loan_temp, aes(y = (EstimatedLoss * 100), x = ProsperScore)) + 
  geom_point(color = '#e1b582', position='jitter', alpha = 0.1) +
  ggtitle('Prosper score') +
  labs(y = '(%) - Estimated loss.', x="From 1 (higher risk) to 10 (lower risk)") 
# scatter plot from EstimatedLoss (percent) by CreditScore
p2 <- ggplot(aes(y = (EstimatedLoss * 100), x =  CreditScore ), data = prosper_loan) + 
  geom_point(color = '#e1b582', position='jitter', alpha = 0.1) +
  ggtitle('Estimated Loss by credit score.')+        
  labs(y = '(%) - Estimated loss.', x = 'Credit score.')   

#show both scatter plot in the same chart.
grid.arrange(p1, p2, ncol  = 2)
rm(prosper_loan_temp)
```

The relationship between credit score, prosper rating by estimated loss is not strong. 5% loss is found in prosper score varying from 3 to 10. The same happens with credit score, a credit score of 750 can be a loss varying from 1% to 15%.  
**What happens with the estimated return when the risk change?**  

```{r echo=FALSE, warning = FALSE}
#not na ProsperRating..Alpha.
notempty_posperRating()
#build 3 scatter plot.
#first from estimatedreturn by ProsperRating..Alpha.
p1 <- ggplot(aes(y = (EstimatedReturn * 100), x = ProsperRating..Alpha.), data = prosper_loan_temp) + 
  geom_point(alpha = 0.1, color='#a2b285', position = 'jitter') + 
  scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E','HR')) +
  stat_summary(fun.y = mean, colour = "darkred", geom = "point", size = 3) + 
  ggtitle('Prosper rating by estimated return.') +       
  
  labs(x = 'AA (lower risk) to HR (higher risk, higher return).', y = '(%) Estimated return.') 
# filter ProsperScore != '', ProsperScore != 11
notempty_valid_ProsperScore()
prosper_loan_temp$ProsperScore <- as.factor(prosper_loan_temp$ProsperScore)

#second from estimatedreturn by ProsperScore.
p2 <- ggplot(prosper_loan_temp, aes(y = (EstimatedReturn * 100), x = ProsperScore)) + 
  geom_point(color = '#e1b582', position = 'jitter', alpha = 0.1) +
  stat_summary(fun.y = mean, colour = "darkred", geom = "point", size = 3) + 
  ggtitle('Prosper score by estimated return') +
  labs(y = '(%) - Estimated return.', x="From 1 (higher risk) to 10 (lower risk)") 

#third from estimatedreturn by CreditScore .
p3 <- ggplot(aes(y = (EstimatedReturn * 100), x =  CreditScore ), data = prosper_loan) + 
  geom_point(color = '#e1b582', position = 'jitter', alpha = 0.1) +
  stat_summary(fun.y = mean, colour = "darkred", geom = "point", size = 3) + 
  ggtitle('Credit score by estimated return.')+        
  labs(y = '(%) - Estimated return.', x = 'Credit score.')   

grid.arrange(p1, p2, p3, ncol  = 3)
rm(prosper_loan_temp)
```

Not all the plots show a strong relationship between the risk and the estimated return. 
The prosper rating plot better explains the estimated return behavior. The intermediate risk, like C and D, brings the higher estimated return.  
**What is the risk level choice by investors?**  

```{r echo=FALSE}
#filter ProsperRating..Alpha not empty
notempty_posperRating()
#scatter plot from investor by ProsperRating..Alpha.
ggplot(aes(y = Investors, x = ProsperRating..Alpha.), data = prosper_loan_temp) + 
  geom_point(alpha = 0.01,color = '#7d874c',position = 'jitter')  +
  ggtitle('Number of investor by prosper rating.')+      
  scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E', 'HR'))  +
  labs(x = 'AA (lower risk) to HR (higher risk).', y = 'Number of investor.') 
rm(prosper_loan_temp)
``` 

The plot shows the loans with less than 100 investors risk more, however more the number of investor, safer is the rating choice.  
**What is the loan amount available for borrowing according the risk?**  
A similar behavior from the investor is found when the variable is loan amount.  

```{r echo=FALSE}
#filter ProsperRating..Alpha not empty
notempty_posperRating()
#scatter plot from LoanOriginalAmount by ProsperRating..Alpha.
ggplot(aes(y = LoanOriginalAmount, x = ProsperRating..Alpha.), data = prosper_loan_temp) + 
  geom_point(alpha= 0.05, color = '#68896a', position = 'jitter') + 
  scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E', 'HR'))  +
  ggtitle('Loan amount by prosper rating.') +        
  labs(x = 'AA (lower risk) to HR (higher risk).', y = 'Loan amount.')

rm(prosper_loan_temp)
``` 

The safer the rating the higher is the amount. For value lower than 5 thousand, the concentration is distributed similarly among the prosper rating with exception the AA prosper rating that shows a low concentration. When the loan amount increments 5 thousand, the HR rating is abrupt reduced and the same happens with E rating when the loan amount is higher than 10 thousand, and with D when it is higher than 15 thousand. For the highest loan amount, the concetration is around A and B ratings.  

##Income range  

**What happen with the loss and return investment according the income range?**  
The next two plots show the impact of the income on the estimated loss and estimated return.  

```{r echo=FALSE, warning = FALSE}
#scatter plot from incomerange by estimatedloss
ggplot(aes(x = IncomeRange, y = EstimatedLoss ), data = prosper_loan) + 
  geom_boxplot(aes(color = IncomeRange), show.legend = FALSE) + 
  stat_summary(fun.y = mean, colour = "darkred", geom = "point", size = 3) + 
  scale_x_discrete(limits = c('Not employed', '$1-24,999', '$25,000-49,999', '$50,000-74,999', '$75,000-99,999', '$100,000+')) +
  ggtitle('Estimated loss by income range.')+        
  labs(x = 'Income range.', y = 'Estimated loss.') 
  
```     

The previous plot shows a box plot from the estimated loss by income range. The first quartile, the third quartile and the mean(red point inside the box plot) decrease as the income range increase.  

```{r echo=FALSE, warning = FALSE}
#scatter plot from incomerange by EstimatedReturn
ggplot(aes(x = IncomeRange, y = EstimatedReturn ), data = prosper_loan)   + 
geom_boxplot(aes(color = IncomeRange), show.legend = FALSE) + 
  stat_summary(fun.y = mean, colour = "darkred", geom = "point", size = 3) + 
  scale_x_discrete(limits = c('Not employed', '$1-24,999', '$25,000-49,999', '$50,000-74,999', '$75,000-99,999', '$100,000+')) +
  ggtitle('Estimated return by income range.')+        
  labs(x = 'Income range.', y = 'Estimated return.') 
```     

The same behavior from estimated loss by income range is found when we compare the estimated return by income range. The first, third quartile and the mean from estimated return variable decrease as the income range variable increase.  

**How much is the loss loan by risk level?**  
Until now, the analysis was about the estimated loss. The next plot will tell the amount of default loan by LP_NetPrincipalLoss, the principal that remains uncollected after any recoveries.  

```{r echo=FALSE}
#filter ProsperRating..Alpha. != '' and LoanStatus == 'Defaulted'
prosper_loan_default <- prosper_loan %>%
  filter(ProsperRating..Alpha. != '', LoanStatus == 'Defaulted')

#scatter plot from ProsperRating..Alpha. by LP_NetPrincipalLoss
ggplot(aes(ProsperRating..Alpha., LP_NetPrincipalLoss),data = prosper_loan_default) +
  geom_point(color='#7d874c', position='jitter') +
  ggtitle('Prosper rating filtering by default loans') +
  scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E','HR')) +
  labs(x = "AA (lower risk, lower return) to HR (higher risk, higher return).", y = 'Principal loss') 
rm(prosper_loan_default)
```

Riskier is the prosper rating, higher is the amount of the default loan. There is a amount limit available by loan according the risk, and because of this, the amount default loan for HR risk level is lower than A. 
**How much is the borrower rate according the risk level?**  

```{r echo=FALSE}
#filter ProsperRating..Alpha not empty
notempty_posperRating()
#scatter plot from ProsperRating..Alpha. by BorrowerAPR
ggplot(aes(ProsperRating..Alpha., BorrowerAPR), data = prosper_loan_temp) +
  geom_point( alpha = 0.05, position = "jitter", colour = "#e1b582", fill = "#e1b582") + 
  ggtitle('Borrower rate by prosper rating.') +
    scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E','HR')) +
  labs(x = "AA (lower risk, lower return) to HR (higher risk, higher return).", y = 'Borrower rate.') 
rm(prosper_loan_temp)
```

This plot shows a strong relationship between the borrower rate and the risk level, the borrower rate increase when the risk level increase.  

# Bivariate Analysis

**What is the best risk classifications?**  
After analyze different risk classification, the prosper rating feature showed the estimated loss, estimated return and the amount of default loans is going to be lower for safer classification than for higher risk definition.   

**What happens to investment return when the risk classification rate vary?**  
On average, the estimated return increase when the classification is riskier, but, for the higher risk classification, the average decrease and the estimated loss increase.

**How can I be sure the classification works?**   
The amount of default loan by risk classification showed the riskier classification has higher concentration of default loan, what means, the loss estimation reflects the amount of default loan.

### What was the strongest relationship you found?  
I found two strong relationship, estimated loss by prosper rating and the borrower rate by by prosper rating.

# Multivariate Plots Section

**Do higher incomes range change the borrower risk classification and the estimated loss?**

```{r echo=FALSE, message=FALSE, warning=FALSE}
#filter ProsperRating..Alpha not empty
notempty_posperRating()

ggplot(aes(IncomeRange, EstimatedLoss), data = prosper_loan_temp) +
    geom_point(aes(color = ProsperRating..Alpha., fill = ProsperRating..Alpha.), position = 'jitter', alpha = 0.1) +
    scale_x_discrete(limits = c('Not employed', '$1-24,999', '$25,000-49,999', '$50,000-74,999', '$75,000-99,999', '$100,000+')) +
    scale_color_manual(values = c('#fb7676', '#6ef96e','#4e4ef8','#f9d961','#878787','#317256','#181818')) + 
    scale_fill_manual(values = c('#fb7676', '#6ef96e','#4e4ef8','#f9d961','#878787','#317256','#181818')) + 
    theme(legend.position = "bottom") +
  ggtitle('Estimated loss by income range coloured grouped prosper rating.') +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  labs(x = 'Income range.', y = 'Estimated loss')
rm(prosper_loan_temp)
``` 

The number of loans increase as the income range increase. The higher risk highlighted to both  not employed borrower and income range below 24,000, what means the estimated loss is higher for borrower with low-income range. The borrower with income rate between 24,999, and 74,999 has the estimated loss and prosper rating equally distributed. For income range above 74,999 the borrowers fit the safer classification and the estimated loss decrease.  
**How much is the loss and deliquency loan by risk level?**  

```{r echo=FALSE, message=FALSE, warning=FALSE}

#create a dataframe with a variable deliquency == 1, to sum the number of delinquency.   
prosper_loan_default <-   prosper_loan %>%
  mutate(delinquency = ifelse(substr(LoanStatus,1,8) == 'Past Due',1,0)) %>% 
  as.data.frame()
#create a dataframe with a variable Defaulted == 1, to sum the number of Defaulted. 
prosper_loan_default <- prosper_loan_default %>%
  mutate(defaulted = ifelse(LoanStatus == 'Defaulted',1,0)) %>% 
  as.data.frame()
#filter delinquency or defaulted loan
prosper_loan_default <- prosper_loan_default %>%
  filter(defaulted == 1 | delinquency == 1)
#gather the delinquency and default loan in the same variable
prosper_loan_default <- prosper_loan_default %>%
  filter(ProsperRating..Alpha. != '') %>%
  gather(key, value, delinquency:defaulted)
#scatter plot from ProsperRating..Alpha. by LP_NetPrincipalLoss
ggplot(aes(x = ProsperRating..Alpha., y = LP_NetPrincipalLoss, fill = key, color = key), data = prosper_loan_default) +
  geom_point(position='jitter',alpha = 0.3) +
  scale_fill_manual(values = c('#4e4ef8', '#5e292f')) + 
  scale_color_manual(values = c('#4e4ef8', '#5e292f')) +
  scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E','HR')) +
  labs(x = "AA (lower risk) to HR (higher risk).", y = 'Count of default or delinquency loans')   
rm(prosper_loan_default)
```

After add the delinquent loans at the plot, the concentration became more evident in the riskier prosper rating.
**I would like to know if the numbers of loans by prosper rating has increase over the years**  

```{r echo=FALSE, message=FALSE, warning=FALSE}
#filter ProsperRating..Alpha not empty
notempty_posperRating()
#scatterplot from the original amount by ProsperRating..Alpha.
ggplot(aes(y = LoanOriginalAmount, x = ProsperRating..Alpha., color = year), data = prosper_loan_temp) + 
  geom_point(alpha = 0.01, position = 'jitter') + 
  facet_grid(year~.)  + 
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E','HR'))  +
  ggtitle('Loan amount by prosper rating grouped by year.')+        
  labs(x = 'AA (lower risk) to HR (higher risk).', y = 'Loan amount.') 
rm(prosper_loan_temp)
```

After 2008, for safer and intermediary risk classification, AA to D, the numbers and amount loan has increased and for riskier classification, keep the same.  
**What is the risk preference when the investor fund a loan over the years?**  

```{r echo=FALSE, message=FALSE, warning=FALSE}
#filter ProsperRating..Alpha not empty
notempty_posperRating()
#scatter plot from investor by ProsperRating..Alpha. grouped by year.
ggplot(aes(y = Investors, x = ProsperRating..Alpha., color = year), data = prosper_loan_temp) + 
  geom_point(alpha = 0.01, position = 'jitter')  +
  facet_grid(year~.)  + 
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  ggtitle('Number of investor by prosper rating grouped by year.')+      
  scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E', 'HR'))  +
  labs(x = 'Prosper rating from AA (lower risk, lower return) to HR (higher risk, higher return).', y = 'Number of investor.') 
rm(prosper_loan_temp)
```

From 2009 to 2014, the number of loan with more than 250 investor has increased. As already analyzed before, loan with more than 100 investors, prefer safer risk classification.  
**How much is the borrower rate and estimated loss according the risk level?**  

```{r echo=FALSE, warning = FALSE}
#filter ProsperRating..Alpha not empty
notempty_posperRating()
#scatter plot from EstimatedLoss by borrowerapr rate 
ggplot(aes(EstimatedLoss, BorrowerAPR), data = prosper_loan_temp)+
  geom_point(aes(color = ProsperRating..Alpha., fill = ProsperRating..Alpha.), alpha = 0.05) +
  guides(colour = guide_legend(override.aes = list(alpha = 1))) +
  ggtitle('Borrower rate by estimated loss grouped by prosper rating.') +
  scale_color_manual(values = c('#fb7676', '#6ef96e','#4e4ef8','#f9d961','#878787','#317256','#181818')) + 
  scale_fill_manual(values = c('#fb7676', '#6ef96e','#4e4ef8','#f9d961','#878787','#317256','#181818')) +   
  labs(x = 'Estimated loss.', y = 'Borrower rate.')
rm(prosper_loan_temp)
```

Borrowers that fit low risk classification has its rates and the estimated loss lower. As the risk classification increase, the borrower rate has a higher variation at high level than borrower that fit low risk classification.  

# Multivariate Analysis  

### Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?  
The most important feature is the prosper rating. It has strong relationship with keys business variables, like borrower rate, estimated loss and with less intensity, the estimated return.  

### Were there any interesting or surprising interactions between features?  
I was surprised with the Estimated loss by income range coloured grouped prosper rating plot. I thought the borrower with high income range will fit safer risk classification, however the plot showed for salary above 24,999 the classification is almost the same.  

# Final Plots and Summary  

Before the analysis, I thought the most important features of the dataset were the estimated loss and the estimated return. During the analysis, I figured out the most important feature is the prosper rating. 
The next 3 plots was carefully chosen to explain the prosper rating importance.  

### Plot One  

```{r echo=FALSE}
#filter ProsperRating..Alpha not empty
notempty_posperRating()
#scatterplot from ProsperRating..Alpha. by estimated loss
ggplot(aes(ProsperRating..Alpha., EstimatedLoss), data = prosper_loan_temp) +
  geom_point( alpha = 0.05, position = "jitter", colour = "#e1b582", fill = "#e1b582") + 
  ggtitle('Estimated loss by prosper rating.') +
    scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E','HR')) +
  labs(x = "AA (lower risk) to HR (higher risk, higher return).", y = 'Estimated loss.') 
rm(prosper_loan_temp)
```

The first plot is about the estimated loss by prosper rating. The prosper rating can predict the estimated loss. Prosper rating with lower risk has lower estimated loss, as the risk increase the estimated loss also increase.  

### Plot Two

```{r echo=FALSE}
notempty_posperRating()
#scatterplot from ProsperRating..Alpha. by EstimatedReturn
ggplot(aes(y = (EstimatedReturn * 100), x = ProsperRating..Alpha.), data = prosper_loan_temp) + 
  geom_point(alpha= 0.1,color='#a2b285',position='jitter') + 
  scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E','HR')) +
  stat_summary(fun.y = mean, colour = "darkred", geom = "point", size = 3) + 
  ggtitle('Prosper rating by estimated return.') +       
  labs(x = 'AA (lower risk) to HR (higher risk).', y = '(%) Estimated return.') 
rm(prosper_loan_temp)
```

This second plot is about the estimated return by prosper rating. On average, higher is the risk, higher is the estimated return. The exception is the higher risk classification, the average is lower than the E level, and there were outliers in the negative estimated return area of the plot.  

### Plot Three

```{r echo=FALSE, warning = FALSE}

#create a dataframe with a variable deliquency == 1, to sum the number of delinquency.   
prosper_loan_default <-   prosper_loan %>%
  mutate(delinquency = ifelse(substr(LoanStatus,1,8) == 'Past Due',1,0)) %>% 
  as.data.frame()
#create a dataframe with a variable Defaulted == 1, to sum the number of Defaulted. 
prosper_loan_default <- prosper_loan_default %>%
  mutate(defaulted = ifelse(LoanStatus == 'Defaulted',1,0)) %>% 
  as.data.frame()
#filter delinquency or defaulted loan
prosper_loan_default <- prosper_loan_default %>%
  filter(defaulted == 1 | delinquency == 1)
#gather the delinquency and default loan in the same variable
prosper_loan_default <- prosper_loan_default %>%
  filter(ProsperRating..Alpha. != '') %>%
  gather(key, value, delinquency:defaulted)
#scatter plot from ProsperRating..Alpha. by LP_NetPrincipalLoss
ggplot(aes(x = ProsperRating..Alpha., y = LP_NetPrincipalLoss, fill = key, color = key), data = prosper_loan_default) +
  geom_point(position='jitter',alpha = 0.3) +
  scale_fill_manual(values = c('#4e4ef8', '#5e292f')) + 
  scale_color_manual(values = c('#4e4ef8', '#5e292f')) +
  scale_x_discrete(limits = c('AA', 'A', 'B', 'C', 'D', 'E','HR')) +
  labs(x = "AA (lower risk) to HR (higher risk).", y = 'Count of default or delinquency loans')   
rm(prosper_loan_default)  
```

The third plot confirm the prosper rating works. The amount of delinquent or default loans concentrate in the riskier levels.  
Prosper rating is the most important feature because it allows the investor measure the investment risk. Based in their characteristic, the investor can choose better return and higher risk as well as lower return and lower risk.  
For an investor who wants guarantee the prosper rating works, they can show the default and delinquent loan distribution by prosper rating and they will see riskier the concentration of default and delinquent loan is in the riskier level.  
  
# Reflection

Work in this project was amazing. I really learned a lot with my many mistakes. The first one, I didn't know the company and the business rule, and I didn't study about it before analysis the data. The second, I didn't know what question I should ask to the data. And then, the worst of them, I tried to follow similar work available on Internet about the same dataset. After spend around 40 hours of work, many histogram available and no understand about what I was doing, I researched about the company on the internet, I read many reviews about the company, explanation about how to get a loan and how to be a investor, and information about its business at www.prosper.com.  

After the research, I drove my effort to know what question I should ask to the dataset. Carefully, I read the description of each variable available at the loan dataset dictionary[8] and the first doubt showed up, **why should a investor fund a loan?** This doubt, drove me to many question: **How much is the return or loss an investor can have? Are there a classification that differ the safer from the riskier loan? How many investor can a loan have?**  
The questions made the work easier. There were 82 variables available, however fewer of them could answer these questions.  

I figured out the variable Prosper rating was one of the most important feature. This variable has strong relationship with the estimated loss, borrower rate, the most part of the default loan were found in the risker level definition and a less strong relationship with the estimated return. It is a perfect ruler to drive investor who prefers riskier loan and higher return from investor who prefers to invest in safer loans.  

It was interesting to know  the higher risk don't give the higher return. Investor can get higher return with intermediary classification risk.  

Surprised me the difference from the borrower rate charged by a US Company and the rate charge by a Brazilian companies. The Brazilian borrower rate is around 6 time higher.  

For future work, I would like to develop a model to predict the rate classification a borrower fits and create a model to compare the estimated return, estimated loss and the classification ruler and how the default loan fit inside the ruler with other investment options available on the market and verify the best options.  

# References.

[1]https://www.investopedia.com/terms/i/investor.asp  
[2]https://www.thebalance.com/are-long-term-or-short-term-investments-better-2385918  
[3]https://www.investopedia.com/terms/i/income.asp#ixzz58PVUEsPQ   
[4]http://www.lendingmemo.com/prosper-loan-complaints/  
[5]https://www.investopedia.com/terms/d/delinquency-rate.asp  
[6]https://www.prosper.com/invest  
[7]https://en.wikipedia.org/wiki/Debt-to-income_ratio  
[8]https://docs.google.com/spreadsheets/d/1gDyi_L4UvIrLTEC6Wri5nbaMmkGmLQBk-Yx3z0XDEtI/edit#gid=0    
[9]https://en.wikipedia.org/wiki/Loan  
[10]https://en.wikipedia.org/wiki/Credit_manager  